# Video 标签详解

## HTML Video 标签常用属性

### 基础属性

| 属性 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `src` | string | 视频文件的 URL | `<video src="video.mp4"></video>` |
| `poster` | string | 视频封面图片 URL | `<video poster="cover.jpg"></video>` |
| `preload` | string | 预加载策略：`none`（不预加载）、`metadata`（只加载元数据）、`auto`（自动加载） | `<video preload="metadata"></video>` |
| `autoplay` | boolean | 是否自动播放 | `<video autoplay></video>` |
| `loop` | boolean | 是否循环播放 | `<video loop></video>` |
| `muted` | boolean | 是否静音 | `<video muted></video>` |
| `controls` | boolean | 是否显示控制条 | `<video controls></video>` |
| `width` | number | 视频宽度（像素） | `<video width="640"></video>` |
| `height` | number | 视频高度（像素） | `<video height="360"></video>` |
| `playsinline` | boolean | 在 iOS Safari 中内联播放（不进入全屏） | `<video playsinline></video>` |
| `crossorigin` | string | CORS 设置：`anonymous`、`use-credentials` | `<video crossorigin="anonymous"></video>` |

### 示例

```html
<video 
  src="video.mp4"
  poster="cover.jpg"
  width="640"
  height="360"
  controls
  preload="metadata"
  playsinline
  muted
  loop>
  您的浏览器不支持 video 标签
</video>
```

## Video 对象属性

### 媒体属性

| 属性 | 类型 | 说明 | 只读 |
|------|------|------|------|
| `currentTime` | number | 当前播放时间（秒） | 否 |
| `duration` | number | 视频总时长（秒），NaN 表示未知 | 是 |
| `volume` | number | 音量（0.0 - 1.0） | 否 |
| `muted` | boolean | 是否静音 | 否 |
| `paused` | boolean | 是否暂停 | 是 |
| `ended` | boolean | 是否播放结束 | 是 |
| `seeking` | boolean | 是否正在跳转 | 是 |
| `readyState` | number | 就绪状态（见下方详解） | 是 |
| `networkState` | number | 网络状态 | 是 |
| `buffered` | TimeRanges | 已缓冲的时间范围 | 是 |
| `played` | TimeRanges | 已播放的时间范围 | 是 |
| `seekable` | TimeRanges | 可跳转的时间范围 | 是 |

### 视频属性

| 属性 | 类型 | 说明 | 只读 |
|------|------|------|------|
| `videoWidth` | number | 视频原始宽度 | 是 |
| `videoHeight` | number | 视频原始高度 | 是 |
| `width` | number | 显示宽度 | 否 |
| `height` | number | 显示高度 | 否 |

### 示例

```javascript
const video = document.querySelector('video');

// 获取当前播放时间
console.log(video.currentTime); // 12.5

// 设置播放时间（跳转）
video.currentTime = 30;

// 获取总时长
console.log(video.duration); // 120.5

// 设置音量（0-1）
video.volume = 0.5;

// 检查是否暂停
if (video.paused) {
  video.play();
}
```

## readyState 值详解

`readyState` 表示视频元素的就绪状态，是一个数字值，对应不同的加载阶段。

### readyState 值对照表

| 值 | 常量名 | 说明 | 对应事件 |
|----|--------|------|----------|
| `0` | `HAVE_NOTHING` | 没有关于媒体资源的任何信息 | - |
| `1` | `HAVE_METADATA` | 已获取媒体资源的元数据（时长、尺寸等） | `loadedmetadata` |
| `2` | `HAVE_CURRENT_DATA` | 已获取当前播放位置的数据，但不足以播放 | `loadeddata` |
| `3` | `HAVE_FUTURE_DATA` | 已获取当前及未来足够的数据，可以开始播放 | `canplay` |
| `4` | `HAVE_ENOUGH_DATA` | 已获取足够的数据，可以流畅播放 | `canplaythrough` |

### 常量定义

```javascript
const video = document.querySelector('video');

// readyState 常量（只读）
console.log(video.HAVE_NOTHING);        // 0
console.log(video.HAVE_METADATA);      // 1
console.log(video.HAVE_CURRENT_DATA);  // 2
console.log(video.HAVE_FUTURE_DATA);   // 3
console.log(video.HAVE_ENOUGH_DATA);   // 4

// 当前状态
console.log(video.readyState); // 当前值（0-4）
```

### readyState 状态流转

```
HAVE_NOTHING (0)
    ↓
HAVE_METADATA (1)      ← loadedmetadata 事件
    ↓
HAVE_CURRENT_DATA (2)  ← loadeddata 事件
    ↓
HAVE_FUTURE_DATA (3)   ← canplay 事件
    ↓
HAVE_ENOUGH_DATA (4)   ← canplaythrough 事件
```

## Video 事件详解

### 加载相关事件

| 事件 | 触发时机 | readyState | 说明 |
|------|----------|------------|------|
| `loadstart` | 开始加载媒体资源 | 0 | 浏览器开始查找媒体资源 |
| `durationchange` | 时长信息可用时 | 1+ | duration 属性发生变化 |
| `loadedmetadata` | 元数据加载完成 | 1 | 视频的元数据（时长、尺寸等）已加载 |
| `loadeddata` | 第一帧数据加载完成 | 2 | 当前播放位置的数据已加载 |
| `progress` | 下载进度更新 | 1-4 | 媒体资源下载进度更新 |
| `canplay` | 可以开始播放 | 3 | 有足够数据开始播放，但可能卡顿 |
| `canplaythrough` | 可以流畅播放 | 4 | 有足够数据流畅播放到结束 |
| `stalled` | 下载停滞 | - | 浏览器尝试获取数据但未收到 |
| `suspend` | 下载暂停 | - | 浏览器暂停下载（可能因为完成或用户操作） |
| `abort` | 下载中止 | - | 下载被中止（非错误） |
| `error` | 加载错误 | - | 加载过程中发生错误 |
| `emptied` | 媒体元素被清空 | 0 | 媒体元素被重置为空状态 |

### 播放相关事件

| 事件 | 触发时机 | 说明 |
|------|----------|------|
| `play` | 开始播放 | 调用 play() 方法或用户点击播放 |
| `playing` | 正在播放 | 播放中（从暂停/缓冲恢复） |
| `pause` | 暂停播放 | 调用 pause() 方法或用户点击暂停 |
| `waiting` | 等待数据 | 由于数据不足而暂停，等待缓冲 |
| `seeking` | 开始跳转 | 开始跳转到新位置 |
| `seeked` | 跳转完成 | 跳转到新位置完成 |
| `timeupdate` | 播放时间更新 | currentTime 更新（约每 250ms 触发一次） |
| `ended` | 播放结束 | 播放到结尾 |
| `ratechange` | 播放速度改变 | playbackRate 改变 |
| `volumechange` | 音量改变 | volume 或 muted 改变 |

### 事件监听示例

```javascript
const video = document.querySelector('video');

// readyState 相关事件
video.addEventListener('loadedmetadata', () => {
  console.log('元数据加载完成');
  console.log('时长:', video.duration);
  console.log('尺寸:', video.videoWidth, 'x', video.videoHeight);
  console.log('readyState:', video.readyState); // 1
});

video.addEventListener('loadeddata', () => {
  console.log('第一帧数据加载完成');
  console.log('readyState:', video.readyState); // 2
});

video.addEventListener('canplay', () => {
  console.log('可以开始播放');
  console.log('readyState:', video.readyState); // 3
});

video.addEventListener('canplaythrough', () => {
  console.log('可以流畅播放');
  console.log('readyState:', video.readyState); // 4
});

// 播放控制事件
video.addEventListener('play', () => {
  console.log('开始播放');
});

video.addEventListener('playing', () => {
  console.log('正在播放');
});

video.addEventListener('pause', () => {
  console.log('暂停播放');
});

video.addEventListener('ended', () => {
  console.log('播放结束');
});

video.addEventListener('timeupdate', () => {
  console.log('当前时间:', video.currentTime);
});

video.addEventListener('waiting', () => {
  console.log('等待缓冲...');
});

video.addEventListener('seeking', () => {
  console.log('跳转中...');
});

video.addEventListener('seeked', () => {
  console.log('跳转完成');
});

// 错误处理
video.addEventListener('error', (e) => {
  console.error('加载错误:', e);
  const error = video.error;
  if (error) {
    switch (error.code) {
      case error.MEDIA_ERR_ABORTED:
        console.error('用户中止');
        break;
      case error.MEDIA_ERR_NETWORK:
        console.error('网络错误');
        break;
      case error.MEDIA_ERR_DECODE:
        console.error('解码错误');
        break;
      case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
        console.error('格式不支持');
        break;
    }
  }
});
```

## 完整示例

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video 播放示例</title>
  <style>
    .video-container {
      max-width: 800px;
      margin: 0 auto;
    }
    .info {
      margin-top: 20px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
    }
    .info-item {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="video-container">
    <video 
      id="myVideo"
      src="video.mp4"
      poster="cover.jpg"
      width="100%"
      controls
      preload="metadata"
      playsinline>
      您的浏览器不支持 video 标签
    </video>
    
    <div class="info">
      <div class="info-item">状态: <span id="status">-</span></div>
      <div class="info-item">readyState: <span id="readyState">-</span></div>
      <div class="info-item">时长: <span id="duration">-</span></div>
      <div class="info-item">当前时间: <span id="currentTime">-</span></div>
      <div class="info-item">缓冲进度: <span id="buffered">-</span></div>
    </div>
  </div>

  <script>
    const video = document.getElementById('myVideo');
    const statusEl = document.getElementById('status');
    const readyStateEl = document.getElementById('readyState');
    const durationEl = document.getElementById('duration');
    const currentTimeEl = document.getElementById('currentTime');
    const bufferedEl = document.getElementById('buffered');

    // 更新信息显示
    function updateInfo() {
      const states = ['HAVE_NOTHING', 'HAVE_METADATA', 'HAVE_CURRENT_DATA', 'HAVE_FUTURE_DATA', 'HAVE_ENOUGH_DATA'];
      readyStateEl.textContent = `${video.readyState} (${states[video.readyState]})`;
      durationEl.textContent = isNaN(video.duration) ? '-' : `${video.duration.toFixed(2)}秒`;
      currentTimeEl.textContent = `${video.currentTime.toFixed(2)}秒`;
      
      if (video.buffered.length > 0) {
        const bufferedEnd = video.buffered.end(video.buffered.length - 1);
        bufferedEl.textContent = `${bufferedEnd.toFixed(2)}秒`;
      }
    }

    // readyState 相关事件
    video.addEventListener('loadedmetadata', () => {
      statusEl.textContent = '元数据加载完成';
      updateInfo();
    });

    video.addEventListener('loadeddata', () => {
      statusEl.textContent = '第一帧数据加载完成';
      updateInfo();
    });

    video.addEventListener('canplay', () => {
      statusEl.textContent = '可以开始播放';
      updateInfo();
    });

    video.addEventListener('canplaythrough', () => {
      statusEl.textContent = '可以流畅播放';
      updateInfo();
    });

    // 播放控制事件
    video.addEventListener('play', () => {
      statusEl.textContent = '播放中';
    });

    video.addEventListener('pause', () => {
      statusEl.textContent = '已暂停';
    });

    video.addEventListener('ended', () => {
      statusEl.textContent = '播放结束';
    });

    video.addEventListener('waiting', () => {
      statusEl.textContent = '缓冲中...';
    });

    video.addEventListener('timeupdate', () => {
      updateInfo();
    });

    // 错误处理
    video.addEventListener('error', () => {
      statusEl.textContent = '加载错误';
      const error = video.error;
      if (error) {
        console.error('错误代码:', error.code);
        console.error('错误信息:', error.message);
      }
    });
  </script>
</body>
</html>
```

## 常用方法

| 方法 | 说明 | 返回值 |
|------|------|--------|
| `play()` | 开始播放 | Promise |
| `pause()` | 暂停播放 | void |
| `load()` | 重新加载媒体资源 | void |
| `canPlayType(type)` | 检查是否支持指定格式 | string（"probably"、"maybe"、""） |

### 方法示例

```javascript
const video = document.querySelector('video');

// 播放
video.play().then(() => {
  console.log('播放成功');
}).catch(error => {
  console.error('播放失败:', error);
});

// 暂停
video.pause();

// 重新加载
video.load();

// 检查格式支持
const canPlayMP4 = video.canPlayType('video/mp4');
console.log(canPlayMP4); // "probably"、"maybe" 或 ""

// 检查 H.264 编码支持
const canPlayH264 = video.canPlayType('video/mp4; codecs="avc1.42E01E"');
```

## 注意事项

1. **autoplay 限制**：现代浏览器通常要求视频静音才能自动播放
2. **iOS Safari**：需要 `playsinline` 属性才能内联播放
3. **格式兼容性**：不同浏览器支持的视频格式不同，建议提供多种格式
4. **readyState 检查**：在操作视频前检查 `readyState` 确保数据已加载
5. **错误处理**：始终监听 `error` 事件处理加载错误

